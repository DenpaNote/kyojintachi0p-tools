pages = [
    {
        "title": "第1章 舎密部警保局捜査1課",
        "sections": [
            [
                "深淵より仰向くもの",
                "この物語はいずれ辿り着く深淵より始まる……",
                "SEI_01",
            ],
            [
                "毒虫",
                "舎密部警保局捜査第１課に配属された新入りの＜オレ＞は何かしっくりこないものを感じながらも、組織の一員としての任務につく。",
                "SEI_01",
            ],
            [
                "朽根",
                "＜ワタナベ＞は舎密部警保局捜査第１課課長・斑猫と年季の入ったバーではじめて酒を飲むことになった。",
                "SEI_01",
            ],
            [
                "官房局装備課１",
                "ワタナベは斑猫から譲り受けたクーガーの試し撃ちのため、装備課に銃弾の調達しに向かうが……",
                "SEI_01",
            ],
            [
                "彼ら――斑猫／吉住／ワタナベ――",
                "銃弾を調達して捜査課に戻ったワタナベは「装備課の女の子」が不愉快そうな視線を斑猫に送るのを見た。",
                "SEI_01",
            ],
            [
                "ただの銃口と彼らの銃口",
                "４８１発の銃弾を手に入れたワタナベはクーガーを手に取り射撃練習場へと向かう。",
                "SEI_01",
            ],
            [
                "毒虫は死なない",
                "射撃練習場で埴谷から斑猫が課長に着任するまでの経緯を聞いたワタナベは「呪いの椅子」と呼ばれた第１課課長の椅子にクーガーの照準を向ける。",
                "SEI_01",
            ],
            [
                "seeing as ...",
                "ワタナベは吉住が装備課へ配属となった顛末について「内偵」を続ける。",
                "SEI_01",
            ],
            [
                "#４１２００１",
                "試し撃ちでクーガーの射撃精度は向上していくが、「内偵」はまったく進展していない。",
                "SEI_01",
            ],
            [
                "官房局装備課２",
                "たんまりあった弾丸を使い切ったワタナベは再度装備課へ調達に向かう。",
                "SEI_01",
            ],
            [
                "L@ve Letter",
                "些細な不正と引き替えに吉住が手渡したラブレターの内容とは……",
                "SEI_01",
            ],
            [
                "one storied ...",
                "捜査課から吉住をはずしたことに斑猫が関わっていた――ワタナベはその斑猫と再びファブリオで酒をのむ。",
                "SEI_01",
            ],
            [
                "L@ve Lettering",
                "ワタナベはラブレターの回答を手にして装備課へ向かう。",
                "SEI_01",
            ],
            [
                "併存する闘争",
                "ワタナベは自己の一部を組織と同化させながら、それ以外の自分が何なのかということを少しずつ見いだしていく。",
                "SEI_01",
            ],
            [
                "或る、唯一の秋",
                "秋雨が降っている。配属から半年あまり経過したワタナベはまだそこにいる。",
                "SEI_01",
            ],
            [
                "社会科準備室におけるエスノメソドロジー",
                "膨雀高校二年で山岳部の部員、重村毅人の内偵。初めての本格的な潜入捜査としてワタナベは山岳部に入部するために顧問がいる社会科準備室で入部届を提出する。",
                "SEI_01",
            ],
            [
                "マンション制圧",
                "重村の潜伏先が判明した。急襲して重村を確保する。",
                "SEI_01",
            ],
            [
                "無実の罪跡",
                "潜伏先には重村の変死体と一つのゲーム。それが意味するものとは……",
                "SEI_01",
            ],
            [
                "捜査１課 ～ 重村の痕跡",
                "斑猫は重村のゲーム上の行動を追い、ワタナベは部屋を覆っていた塗料について調査を始める。",
                "SEI_01",
            ],
            [
                "re:481",
                "調査は着々と進む。その中でワタナベは理由のない射撃衝動にかられ弾丸を手に入れるために装備課へと足を運んでいた。",
                "SEI_01",
            ],
            [
                "弾痕",
                "熱に浮かされたようにワタナベは射撃場で銃弾を消費する。",
                "SEI_01",
            ],
            [
                "ファブリオ",
                "ワタナベと斑猫は互いの調査結果をファブリオで交換する。",
                "SEI_01",
            ],
            [
                "想像と推理、そして事件報告書",
                "事件は解決した――ワタナベはそれを受け入れようとする。",
                "SEI_01",
            ],
            [
                "ワタナベの銃口",
                "捜査課全員を集めたブリーフィングで事件の終結が宣言される。",
                "SEI_01",
            ],
            ["作戦行動開始", "突発的に事象は進展する……", "SEI_01"],
            [
                "射撃場の主",
                "舎密部は敵味方不明の勢力が入り乱れ混乱していた。そんな中ワタナベは射撃場へと向かうが……",
                "SEI_01",
            ],
            ["飼い犬たちの沈黙", "電網研に向かうとそこは無人になっていた……", "SEI_01"],
            [
                "這根の毒虫",
                "捜査課にもどるとそこにはデスクに座って端末を操作する斑猫がいた。",
                "SEI_01",
            ],
            [
                "事件の終わり",
                "互いに警保局局長殺害を主張する諜報課と捜査課の仲介に単独ワタナベが向かう。",
                "SEI_01",
            ],
            [
                "新しい事件",
                "舎密部の内紛は収まった、だが斑猫は戻ってこなかった。",
                "SEI_01",
            ],
        ],
    },
    {
        "title": "第2章 消えた斑猫",
        "sections": [
            [
                "暗函",
                "ワタナベと名付けられた何ものかは名付けられたことによって境界を意識し始める。それは捜査とは完全に区別された個人的な体験だったのか。",
                "SEI_02",
            ],
            [
                "ＸＮＣ２８Ｂ０３９",
                "ワタナベがその得体の知れない薬瓶を振るとクスリたちはざらざらと音をたてた。",
                "SEI_02",
            ],
            [
                "監視カメラ／不等速非直線運動",
                "それは絶対ではないが、だからといって相対というわけではない。何ものかがそう望むように恣意的に見える。",
                "SEI_02",
            ],
            ["ゼロ合目", "ワタナベは＜ここ＞から山頂を臨む。", "SEI_02"],
            [
                "fictional injection",
                "そいつは真実なんかよりも強行に侵入してくるのに、誰もそれに気付かないでいる。",
                "SEI_02",
            ],
            [
                "重村の攻略ノート",
                "そのノートは真新しく数式は物理法則を原則準用している。",
                "SEI_02",
            ],
            [
                "飼い犬たちの夕餉",
                "彼らの首輪に繋がっている鎖は何でできていて、どこにつなぎ止められているのか。",
                "SEI_02",
            ],
            [
                "狙撃する記号たち",
                "現実は記号化され象徴的にワタナベに狙いをさだめる。",
                "SEI_02",
            ],
            [
                "射己",
                "ワタナベの射撃は非芸術的に精確だった。そこには一切の感動はない。",
                "SEI_02",
            ],
            [
                "10/07 AM 08:47:55",
                "彼女はそのとき何を直視していたのだろう。彼女は不敵に笑っている。",
                "SEI_02",
            ],
            ["お月見山入口にて", "ワタナベは終着駅で電車を降りる。", "SEI_02"],
            [
                "お月見山登山道",
                "その道はひっそりとして異様で、ワタナベだけが神妙に歩みを進める。",
                "SEI_02",
            ],
            [
                "お月見山（裏）登山道",
                "日常だけが現実じゃない。非日常もまた現実なのだ。現実は彼らを包囲する。",
                "SEI_02",
            ],
            [
                "彼らの静かなパーティ",
                "そのパーティはその空間の外で最高潮に達していた。",
                "SEI_02",
            ],
            ["青髯の男たち", "彼らはワタナベと積極的にコンタクトを試みた。", "SEI_02"],
            [
                "過重労働――ケイ",
                "お月見山から戻ったワタナベはまず自身の感覚を無意識に批判する――機械的に、非人間的に。",
                "SEI_02",
            ],
            [
                "戦の前に確認すべき唯一の事",
                "すべてを冷静に認識するとき、それ以外はすべて虚妄なのだと認識してしまう。そのときケイは……",
                "SEI_02",
            ],
            [
                "中華屋にて――デッドフィールドへのログイン方法",
                "ＸＮＣ２８Ｂ０３９はデッドフィールドにログインするためのリアルタイム生体認証を実装したナノマシンであることを知らされる。",
                "SEI_02",
            ],
            [
                "電磁被曝保護室",
                "その電磁的な静寂の中でワタナベはデッドフィールドをはじめてプレイする。",
                "SEI_02",
            ],
        ],
    },
    {
        "title": "第3章 DEAD FIELD - campaign",
        "sections": [
            [
                "DEAD FIELD ～ ステージ１",
                "撃破されえるものたちは、撃破されるために為されるべきこと以外に何も語らない。",
                "SEI_02",
            ],
            [
                "DEAD FIELD ～ ステージ１クリア",
                "すべてが撃破された後には撃破されたものとそうでないものが残る。語ることができるのはそうでないないものだけだ。",
                "SEI_02",
            ],
            [
                "DEAD FIELD ～ ロビー UD 587 03/08 14:35:23",
                "気泡は音もなくはじけてなくなると、ビールの表面には太陽の光が差し込んでそれをすべて吸い取って新たに光を放っている。",
                "DF_01",
            ],
            [
                "DEAD FIELD ～ PvP",
                "その戦闘特性はあらゆる算式で合理的に表現された。",
                "DF_01",
            ],
            [
                "DEAD FIELD ～ ロビー UD 587 03/08 17:22:19",
                "気泡は音もなくはじけてなくなると、ビールの表面には照明の光が差し込んでそれをすべて吸い取って新たに光を放っている。",
                "DF_01",
            ],
            [
                "DEAD FIELD ～ 空襲",
                "セイヒアの目撃情報がある東地区へ向かうために輸送手段を探す。",
                "DF_01",
            ],
            [
                "DEAD FIELD ～ ガルニャカ",
                "そこはセイヒアが最後に出撃した場所だった。",
                "DF_01",
            ],
            [
                "DEAD FIELD ～ 雇い主",
                "そのフィールドには見えない札束がひらひらと風に舞っている。",
                "DF_01",
            ],
            [
                "仮想現実障害",
                "デッドフィールドのプレイを中断したワタナベの眼前には確固とした空間が広がっていてすべてが現実的に見えている。",
                "SEI_03",
            ],
            ["救難出動", "セイヒア救出作戦がはじまる。", "DF_02"],
            [
                "救難機出撃",
                "ガルニャカを出撃した救難隊は陽動のため戦闘地区に侵入する。",
                "DF_02",
            ],
            ["要救護者", "ガルニャカ山岳地帯でセイヒアの痕跡を探す。", "DF_02"],
            [
                "奇襲",
                "想定していた最悪の筋書きは実現しなかったが、思いもよらない戦闘に巻き込まれていく。",
                "DF_02",
            ],
            ["RTB", "我、帰還す。ブルバッハは死に、ガルニャカへと帰還する。", "DF_02"],
            [
                "ゲーム中断",
                "ワタナベはセイヒア機の救出に成功したが、機体にセイヒアは搭乗していなかった。",
                "SEI_04",
            ],
            [
                "戦果検証",
                "現実に戻ったワタナベはケイとともデッドフィールドでの行動を検証するが……",
                "SEI_04",
            ],
            [
                "彼我不明車両",
                "燃料ぎれになった重機兵の影でプレイヤーはゲームオーバーを予期していた。",
                "DF_03",
            ],
            [
                "コンティニュー",
                "不愉快な夢から目覚めたワタナベはケイの書き置きを見つけた。",
                "SEI_05",
            ],
            [
                "ゲーマーズ・ハイ",
                "一切無駄のない完璧なプレイ――いや、それ以上の魔術的な高揚をもって敵機を撃破していく。",
                "DF_04",
            ],
            [
                "psychotomimetic game",
                "そのゲームには致死性のある何かが含まれている。",
                "SEI_06",
            ],
            [
                "デッドフィールド開発秘史",
                "誰が、どのようして、何の目的のためにデッドフィールドを作り上げたのか。",
                "SEI_06",
            ],
            [
                "ある生徒の（非）日常",
                "その後も事件は進展しつづけ、ワタナベを掴んだままはなさない。",
                "SEI_06",
            ],
            ["超長距離狙撃", "最大有効射程36000km", "SEI_06"],
            [
                "ヴェールリバーでの戦い",
                "衛星落としの危機は回避した。しかし、本当にこのような無差別攻撃を斑猫は企てたのか？　斑猫に近づこうと過去のヴェールリバー攻防戦へと飛び込む。",
                "SEI_06",
            ],
        ],
    },
    {
        "title": "第4章 DEAD FIELD - AQE",
        "sections": [
            ["臨戦", "瞬間、意識は戦場にあった。", "DF_05"],
            [
                "リモートウェア",
                "不愉快な眩暈から立ち直ると、そこはヴェールリバー基地のパイロット室だった。",
                "DF_05",
            ],
            [
                "unreal arms",
                "ヴェールリバー基地での一般的で少し不可解な服務。",
                "DF_05",
            ],
            ["ミラビリス", "毒虫と再び射撃場で出会う。", "DF_05"],
            [
                "車いすの少女",
                "夜が明ける前、子どもが基地病院へと救急搬送された。基地病院で待っていたのは車いすの少女だった。",
                "DF_05",
            ],
            [
                "小さな葬列",
                "小さな棺がその列を先導した。その葬列に連なるすべてのものは悲しみに暮れていた。",
                "DF_05",
            ],
            [
                "いつか果たされる約束",
                "嵐の射撃場で引き金を引く、そこにはミラビリスも居た。",
                "DF_05",
            ],
            [
                "出撃予告",
                "イベントは起こらず、時間は空転し続ける。そのときケイから出撃を予言される。",
                "DF_05",
            ],
            [
                "ミッションスタート",
                "思いもかけない形でミッションは開始される。",
                "DF_05",
            ],
            [
                "ゲームオーバー",
                "ミッションは終了した。リモートウェアから追い出されると目の前には銃口が向けられていた。",
                "DF_05",
            ],
            [
                "疇昔",
                "過去のヴェールリバーでミラビリスにいったい何があったのか。",
                "DF_05",
            ],
        ],
    },
    {
        "title": "第5章 追跡",
        "sections": [
            [
                "仮想逃避",
                "ワタナベは過去のヴェールリバーから現実へと戻ってきた。",
                "SEI_07",
            ],
            [
                "運び屋",
                "斑猫は道岸DCに潜伏していることが分かった。ワタナベは命令を受け、道岸DCに突入を試みる。",
                "SEI_07",
            ],
            [
                "制圧―道岸DC",
                "当局の支援のもと、斑猫を捕らえるべく道岸DCへと突入する。",
                "SEI_07",
            ],
            ["プロローグ", "ここから新たな物語が始まる。", "SEI_07"],
        ],
    },
]

from typing import TypedDict, List, Dict
import os
import xml.etree.ElementTree as ET

from openpyxl import Workbook
from openpyxl.styles import NamedStyle, Alignment

class Page(TypedDict):
    title: str
    strings: List[List[str]]
    file: str

class Section(TypedDict):
    title: str
    paragraphs: List[Page]

class OhReader:
    def __init__(self):
        self.sections: List[Section] = []

        self.files_and_content_split_by_restore: Dict[str, List[List[str]]] = {}
        self.files = set()

        for page in pages:
            for section in page["sections"]:
                self.files.add(section[2])

        for file in self.files:
            self.files_and_content_split_by_restore[file] = []
            tree = ET.parse(f"{file}.xml")
            temp_list = {}
            for index, child in enumerate(tree.getroot().iter()):
                if child.tag == "restore_tags":
                    self.files_and_content_split_by_restore[file].append(temp_list)
                    temp_list = []
                if child.tail and child.tail.strip():
                    if temp_list:
                        temp_list["index"].append(index)
                        temp_list["text"].append(child.tail)
                    else:
                        temp_list = {
                            "index": [index],
                            "text": [child.tail]
                        }
            if temp_list:
                self.files_and_content_split_by_restore[file].append(temp_list)

        for page in pages:
            big_section: Section = {
                "title": page["title"],
                "paragraphs": []
            }

            for section in page["sections"]:
                file = section[2]
                item = self.files_and_content_split_by_restore[file].pop(0)
                small_section: Page = {
                    "title": section[0],
                    "strings": item["text"],
                    "index": item["index"],
                    "file": file
                }
                big_section["paragraphs"].append(small_section)

            self.sections.append(big_section)

        # export to markdown
        os.makedirs("output", exist_ok=True)
        # for section in self.sections:
        #     root = ET.Element("root")
        #     section_title = ET.SubElement(root, "section_title")
        #     section_title.text = section["title"]
        #     for paragraph in section["paragraphs"]:
        #         page = ET.SubElement(root, "page")
        #         title = ET.SubElement(page, "title")
        #         title.text = paragraph["title"]
        #         page.set("file", paragraph["file"])
        #         for index, strings in zip(paragraph["index"], paragraph["strings"]):
        #             string = ET.SubElement(page, "string")
        #             string.text = strings
        #             string.set("index", str(index))
        #     tree = ET.ElementTree(root)
        #     ET.indent(tree, space=" ", level=0)
        #     tree.write(f"output/{section['title']}.xml", encoding="utf-8", xml_declaration=True)

        for section in self.sections:
            wb = Workbook()

            cell_style = NamedStyle(name="cell_style")
            cell_style.alignment = Alignment(wrap_text=True, vertical="top", horizontal="left")

            ws = wb.active

            ws.append(["file", "page", "index", "ja", "cn"])

            for paragraph in section["paragraphs"]:
                for index, strings in zip(paragraph["index"], paragraph["strings"]):
                    ws.append([paragraph["file"], paragraph["title"], index, strings, ""])

            for row in ws.iter_rows():
                for cell in row:
                    cell.style = cell_style

            ws.column_dimensions["D"].width = 200
            ws.column_dimensions["E"].width = 200

            wb.save(f"{section['title']}.xlsx")


OhReader()
